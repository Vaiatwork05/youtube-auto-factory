name: YouTube Auto Factory - 4x Daily

on:
  workflow_dispatch:
    inputs:
      run_all_slots:
        description: "Créer les 4 vidéos de la journée"
        required: false
        default: false
        type: boolean
  schedule:
    - cron: "0 6 * * *"   # 8h CEST
    - cron: "0 10 * * *"  # 12h CEST
    - cron: "0 14 * * *"  # 16h CEST
    - cron: "0 18 * * *"  # 20h CEST

jobs:
  generate-video:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write
      issues: write

    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v4

      - name: 🐍 Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          cache: "pip"

      - name: 📦 Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg espeak
          echo "✅ FFmpeg et eSpeak installés"

      - name: 🔧 Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          echo "✅ Toutes les dépendances Python installées"

      - name: 📁 Create output directories
        run: |
          mkdir -p output/videos output/audio output/images output/logs
          echo "📁 Dossiers de sortie créés"

      - name: 🧪 Test system
        run: |
          echo "🧪 Test du système..."
          python -c "
          try:
              from content_factory.video_creator import VideoCreator
              from content_factory.audio_generator import AudioGenerator
              from content_factory.image_manager import ImageManager
              print('✅ Tous les modules importés avec succès')
          except Exception as e:
              print(f'❌ Erreur import: {e}')
              exit(1)
          "

      - name: 🎬 Create video(s)
        run: |
          if [ "${{ inputs.run_all_slots }}" = "true" ]; then
            echo "🕒 Début production des 4 vidéos quotidiennes..."
            python content_factory/auto_content_engine.py --all
          else
            echo "🕒 Début production vidéo pour créneau actuel..."
            python content_factory/auto_content_engine.py
          fi

      - name: 📤 Upload video artifacts
        uses: actions/upload-artifact@v4
        with:
          name: youtube-videos-${{ github.run_id }}
          path: output/
          retention-days: 1

      - name: 📊 Show production summary
        if: always()
        run: |
          echo "📊 RAPPORT DE PRODUCTION"
          echo "🕐 Heure: $(date)"
          echo "📹 Vidéos: $(find output/videos -name "*.mp4" | wc -l)"
          echo "🔊 Audios: $(find output/audio -name "*.mp3" | wc -l)"
          echo "🖼️ Images: $(find output/images -name "*.jpg" | wc -l)"

      - name: 🚨 Notification on failure
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '🚨 YouTube Auto Factory - Production Failed',
              body: 'La production vidéo a échoué. Vérifiez les logs: https://github.com/' + context.repo.owner + '/' + context.repo.repo + '/actions/runs/' + context.runId
            })
