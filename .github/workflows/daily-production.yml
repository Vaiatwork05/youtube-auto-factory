name: YouTube Auto Factory - 4x Daily

on:
  workflow_dispatch:
    inputs:
      run_all_slots:
        description: "CrÃ©er les 4 vidÃ©os de la journÃ©e"
        required: false
        default: false
        type: boolean
  schedule:
    - cron: "0 6 * * *"   # 8h CEST
    - cron: "0 10 * * *"  # 12h CEST
    - cron: "0 14 * * *"  # 16h CEST
    - cron: "0 18 * * *"  # 20h CEST

jobs:
  generate-video:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          cache: "pip"

      - name: ğŸ’¾ Cache system packages
        uses: actions/cache@v3
        with:
          path: /var/cache/apt
          key: ${{ runner.os }}-apt-${{ hashFiles('**/.github/workflows/*.yml') }}
          restore-keys: |
            ${{ runner.os }}-apt-

      - name: ğŸ’¾ Cache model downloads
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/tts
            ~/.cache/edge-tts
            ~/.cache/gtts
            ~/.cache/torch
            ~/.cache/huggingface
          key: ${{ runner.os }}-models-${{ github.run_id }}
          restore-keys: |
            ${{ runner.os }}-models-

      - name: ğŸ“¦ Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg espeak
          echo "âœ… FFmpeg et eSpeak installÃ©s"

      - name: ğŸ”§ Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          echo "ğŸ“¦ Installation des packages Python..."
          if [ ! -f "requirements_core.txt" ]; then
            echo "âŒ Fichier requirements_core.txt introuvable"
            exit 1
          fi
          pip install -r requirements_core.txt
          if [ -f "requirements_extra.txt" ]; then
            pip install -r requirements_extra.txt
          fi
          echo "âœ… Toutes les dÃ©pendances Python installÃ©es"

      - name: ğŸ“ Create output directories
        run: |
          mkdir -p output/videos output/audio output/images output/logs
          echo "ğŸ“ Dossiers de sortie crÃ©Ã©s"

      - name: ğŸ§ª Test system
        run: |
          echo "ğŸ§ª Test du systÃ¨me..."
          python -c "
          try:
              from content_factory.video_creator import VideoCreator
              from content_factory.audio_generator import AudioGenerator
              from content_factory.image_manager import ImageManager
              print('âœ… Tous les modules importÃ©s avec succÃ¨s')
          except Exception as e:
              print(f'âŒ Erreur import: {e}')
              exit(1)
          "

      - name: ğŸ” Check Python syntax
        run: |
          echo "ğŸ” VÃ©rification syntaxe Python..."
          python -m py_compile content_factory/video_creator.py
          python -m py_compile content_factory/audio_generator.py
          python -m py_compile content_factory/image_manager.py
          python -m py_compile content_factory/auto_content_engine.py
          echo "âœ… Tous les fichiers Python sont syntaxiquement valides"

      - name: ğŸ¬ Create video(s)
        run: |
          if [ "${{ inputs.run_all_slots }}" = "true" ]; then
            echo "ğŸ•’ DÃ©but production des 4 vidÃ©os quotidiennes..."
            python content_factory/auto_content_engine.py --all
          else
            echo "ğŸ•’ DÃ©but production vidÃ©o pour crÃ©neau actuel..."
            python content_factory/auto_content_engine.py
          fi

      - name: ğŸ“¤ Upload video artifacts
        uses: actions/upload-artifact@v4
        with:
          name: youtube-videos-${{ github.run_id }}
          path: output/
          retention-days: 1

      - name: ğŸ“Š Show production summary
        if: always()
        run: |
          echo "ğŸ“Š RAPPORT DE PRODUCTION"
          echo "========================"
          echo "ğŸ• Heure: $(date)"
          echo "ğŸƒ Workflow: ${{ github.workflow }}"
          echo "ğŸ”§ Run ID: ${{ github.run_id }}"
          echo ""
          echo "ğŸ“¹ VidÃ©os crÃ©Ã©es:"
          find output/videos -name "*.mp4" -type f -exec du -h {} \; | awk '{print "   - " $2 " (" $1 ")"}'
          echo ""
          echo "ğŸ”Š Audios:"
          find output/audio -name "*.mp3" -type f -exec du -h {} \; | awk '{print "   - " $2 " (" $1 ")"}'
          echo ""
          echo "ğŸ–¼ï¸ Images:"
          find output/images -name "*.jpg" -type f | head -5
          echo ""
          echo "ğŸ’¾ Cache activÃ© & optimisation rÃ©ussie âœ…"

      - name: ğŸš¨ Notification on failure
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸš¨ YouTube Auto Factory - Production Failed',
              body: `La production vidÃ©o a Ã©chouÃ©. Veuillez vÃ©rifier les logs du workflow.

              DÃ©tails:
              - Workflow: ${context.workflow}
              - Run: ${context.runId}
              - Commit: ${context.sha}
              - DÃ©clencheur: ${context.eventName}

              Lien vers les logs: https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
            })
