name: ðŸš€ Production - SystÃ¨me avec Configuration Existante

on:
  schedule:
    - cron: '0 6,10,14,18 * * *'
  
  workflow_dispatch:
    inputs:
      force_run:
        description: 'Forcer exÃ©cution du moteur'
        required: true
        default: false
        type: boolean

permissions:
  contents: read

jobs:
  setup:
    name: âš™ï¸ Configuration Initiale
    runs-on: ubuntu-latest
    
    steps:
      - name: â¬‡ï¸ Checkout du code
        uses: actions/checkout@v4

      - name: ðŸ”§ VÃ©rification de la Configuration
        run: |
          echo "## âš™ï¸ VÃ‰RIFICATION DE LA CONFIGURATION"
          
          # VÃ©rifier les fichiers de configuration existants
          config_files=("config.yaml" "config/settings.yaml" "settings.yaml")
          config_found=false
          
          for config_file in "${config_files[@]}"; do
            if [ -f "$config_file" ]; then
              echo "âœ… Configuration trouvÃ©e: $config_file"
              echo "ðŸ“„ Contenu (premiÃ¨res lignes):"
              head -10 "$config_file"
              config_found=true
              break
            fi
          done
          
          if [ "$config_found" = false ]; then
            echo "âš ï¸ Aucun fichier de configuration trouvÃ©, crÃ©ation config.yaml par dÃ©faut..."
            cat > config.yaml << 'EOF'
# Configuration YouTube Auto Factory
PATHS:
  OUTPUT_ROOT: "output"
  AUDIO_DIR: "audio"
  VIDEO_DIR: "videos"
  IMAGE_DIR: "images"
  LOG_DIR: "logs"

WORKFLOW:
  SLOT_HOURS: [8, 12, 16, 20]
  SLOT_PAUSE_SECONDS: 10

CONTENT:
  THEMES: ["technologie", "science", "innovation"]
  DEFAULT_VIDEO_DURATION: 60

YOUTUBE:
  UPLOAD_ENABLED: false

DEBUG:
  ENABLED: false
EOF
            echo "âœ… Configuration par dÃ©faut crÃ©Ã©e: config.yaml"
          fi
          
          echo "## ðŸ“ FICHIERS DE CONFIGURATION DISPONIBLES:"
          find . -name "*.yaml" -o -name "*.yml" | head -10

  verification:
    name: ðŸ” VÃ©rification du SystÃ¨me
    runs-on: ubuntu-latest
    needs: setup
    
    steps:
      - name: â¬‡ï¸ Checkout du code
        uses: actions/checkout@v4

      - name: ðŸ“Š Diagnostic de l'Environnement
        run: |
          echo "## ðŸ–¥ï¸ INFORMATION SYSTÃˆME"
          echo "RÃ©pertoire de travail: $GITHUB_WORKSPACE"
          echo "## ðŸ“ STRUCTURE DU PROJET:"
          find . -type f \( -name "*.py" -o -name "*.yaml" -o -name "*.yml" \) | head -20 | sort

      - name: ðŸ” VÃ©rification des Fichiers Critiques
        run: |
          echo "## ðŸ“‹ VÃ‰RIFICATION DES FICHIERS"
          
          critical_files=(
            "content_factory/auto_content_engine.py"
            "content_factory/config_loader.py"
            "content_factory/content_generator.py"
            "content_factory/video_creator.py"
            "content_factory/youtube_uploader.py"
            "content_factory/utils.py"
            "requirements.txt"
          )
          
          echo "## FICHIERS OBLIGATOIRES:"
          all_critical_exists=true
          for file in "${critical_files[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… $file"
            else
              echo "âŒ $file - MANQUANT"
              all_critical_exists=false
            fi
          done
          
          echo "## FICHIERS DE CONFIGURATION:"
          config_files=("config.yaml" "config/settings.yaml" "settings.yaml")
          config_found=false
          for file in "${config_files[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… $file"
              config_found=true
            fi
          done
          
          if [ "$config_found" = false ]; then
            echo "âš ï¸ Aucun fichier de configuration trouvÃ© (mais un dÃ©faut a Ã©tÃ© crÃ©Ã©)"
          fi
          
          if [ "$all_critical_exists" = false ]; then
            echo "::error::Fichiers critiques manquants"
            exit 1
          fi

      - name: ðŸ§ª Test des Imports et Configuration
        run: |
          echo "## ðŸ TEST DE LA CONFIGURATION"
          export PYTHONPATH=$GITHUB_WORKSPACE:$PYTHONPATH
          
          python -c "
          try:
              print('ðŸ”§ Chargement de la configuration...')
              from content_factory.config_loader import ConfigLoader
              config = ConfigLoader().get_config()
              print('âœ… Configuration chargÃ©e avec succÃ¨s')
              
              # Afficher les paramÃ¨tres importants
              print(f'ðŸ“ Dossier sortie: {config.get(\\\"PATHS\\\", {}).get(\\\"OUTPUT_ROOT\\\", \\\"output\\\")}')
              print(f'â° CrÃ©neaux: {config.get(\\\"WORKFLOW\\\", {}).get(\\\"SLOT_HOURS\\\", [8, 12, 16, 20])}')
              print(f'ðŸ“¤ Upload YouTube: {config.get(\\\"YOUTUBE\\\", {}).get(\\\"UPLOAD_ENABLED\\\", False)}')
              
              print('ðŸ”§ Test autres imports...')
              from content_factory.content_generator import generate_daily_contents
              from content_factory.video_creator import VideoCreator
              from content_factory.utils import ensure_directory
              
              print('ðŸŽ‰ TOUS LES IMPORTS - SUCCÃˆS')
              
          except Exception as e:
              print(f'âŒ ERREUR: {e}')
              import traceback
              traceback.print_exc()
              exit(1)
          "

      - name: ðŸ“¦ VÃ©rification des DÃ©pendances
        run: |
          echo "## ðŸ“¦ VÃ‰RIFICATION REQUIREMENTS.TXT"
          if [ -f "requirements.txt" ]; then
            echo "DÃ©pendances Ã  installer:"
            cat requirements.txt
          else
            echo "âŒ requirements.txt non trouvÃ©"
            exit 1
          fi

  production:
    name: ðŸš€ Moteur de Production
    runs-on: ubuntu-latest
    needs: verification

    env:
      FORCE_RUN: ${{ fromJSON(github.event.inputs.force_run || 'false') }}
      PYTHONPATH: ${{ github.workspace }}

    steps:
      - name: â¬‡ï¸ Checkout du code
        uses: actions/checkout@v4

      - name: ðŸ Configuration Python avec Cache
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'

      - name: ðŸ› ï¸ Installation des DÃ©pendances SystÃ¨me
        run: |
          echo "## ðŸ”§ INSTALLATION FFMPEG"
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          echo "âœ… FFmpeg installÃ©"

      - name: ðŸ“¦ Installation des DÃ©pendances Python
        run: |
          echo "## ðŸ“¦ INSTALLATION DES PAQUETS PYTHON"
          pip install --upgrade pip
          pip install -r requirements.txt
          echo "âœ… DÃ©pendances installÃ©es"

      - name: ðŸ”§ VÃ©rification PrÃ©-Lancement
        run: |
          echo "## ðŸ”§ VÃ‰RIFICATION FINALE"
          export PYTHONPATH=$GITHUB_WORKSPACE:$PYTHONPATH
          
          python -c "
          from content_factory.config_loader import ConfigLoader
          config = ConfigLoader().get_config()
          print('âš™ï¸ Configuration active:')
          print(f'  â€¢ Output: {config.get(\\\"PATHS\\\", {}).get(\\\"OUTPUT_ROOT\\\")}')
          print(f'  â€¢ CrÃ©neaux: {config.get(\\\"WORKFLOW\\\", {}).get(\\\"SLOT_HOURS\\\")}')
          print(f'  â€¢ Upload: {config.get(\\\"YOUTUBE\\\", {}).get(\\\"UPLOAD_ENABLED\\\")}')
          "

      - name: ðŸš€ ExÃ©cution du Moteur de Contenu
        timeout-minutes: 30
        run: |
          echo "## ðŸš€ LANCEMENT DU MOTEUR"
          echo "Mode FORCE: $FORCE_RUN"
          echo "RÃ©pertoire: $(pwd)"
          
          export PYTHONPATH=$GITHUB_WORKSPACE:$PYTHONPATH
          
          python content_factory/auto_content_engine.py --force-run "$FORCE_RUN" --debug
          
          echo "ðŸŽ‰ Moteur exÃ©cutÃ©"

      - name: ðŸ“ Analyse des RÃ©sultats
        if: always()
        run: |
          echo "## ðŸ“ ANALYSE POST-EXÃ‰CUTION"
          if [ -d "output" ]; then
            echo "âœ… Dossier output crÃ©Ã©"
            find output/ -type f | head -10
          else
            echo "âš ï¸ Aucun output crÃ©Ã©"
          fi

      - name: ðŸ’¾ Sauvegarde des RÃ©sultats
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: production-results-${{ github.run_id }}
          path: |
            output/
            *.log
          retention-days: 7

  notification:
    name: ðŸ”” Notification
    runs-on: ubuntu-latest
    needs: [setup, verification, production]
    if: always()

    steps:
      - name: ðŸ“¢ Rapport Final
        run: |
          echo "## ðŸ”” RAPPORT FINAL"
          echo "Setup: ${{ needs.setup.result }}"
          echo "Verification: ${{ needs.verification.result }}"
          echo "Production: ${{ needs.production.result }}"
          
          if [ "${{ needs.verification.result }}" = "success" ] && [ "${{ needs.production.result }}" = "success" ]; then
            echo "ðŸŽ‰ SUCCÃˆS COMPLET"
          else
            echo "âŒ Ã‰CHEC - VÃ©rifier les logs"
          fi
