name: YouTube Auto Factory - 4x Daily

on:
  workflow_dispatch:
    inputs:
      run_all_slots:
        description: 'CrÃ©er les 4 vidÃ©os de la journÃ©e'
        required: false
        default: false
        type: boolean
  schedule:
    - cron: '0 6 * * *'   # 8h CEST
    - cron: '0 10 * * *'  # 12h CEST
    - cron: '0 14 * * *'  # 16h CEST
    - cron: '0 18 * * *'  # 20h CEST

jobs:
  generate-video:
    runs-on: ubuntu-latest
    timeout-minutes: 15  # Timeout raisonnable
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ðŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'  # Cache pip intÃ©grÃ©
        
    - name: ðŸ’¾ Cache system packages
      uses: actions/cache@v3
      with:
        path: /var/cache/apt
        key: ${{ runner.os }}-apt-${{ hashFiles('**/.github/workflows/*.yml') }}
        restore-keys: |
          ${{ runner.os }}-apt-
          
    - name: ðŸ’¾ Cache model downloads
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/tts
          ~/.cache/edge-tts
          ~/.cache/gtts
          ~/.cache/torch
          ~/.cache/huggingface
        key: ${{ runner.os }}-models-${{ github.run_id }}
        restore-keys: |
          ${{ runner.os }}-models-
        
    - name: ðŸ“¦ Install system dependencies
      run: |
        # Mise Ã  jour conditionnelle seulement si le cache n'existe pas
        if [ ! -f /var/cache/apt/archives/lock ]; then
          sudo apt-get update
          sudo apt-get install -y ffmpeg espeak
          echo "âœ… FFmpeg et eSpeak installÃ©s"
        else
          echo "âœ… Cache systÃ¨me trouvÃ© - installation sautÃ©e"
        fi
        
    - name: ðŸ”§ Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        
        echo "ðŸ“¦ Installation des packages Python..."
        
        # VÃ©rification de l'existence des fichiers
        if [ ! -f "requirements_core.txt" ]; then
          echo "âŒ Fichier requirements_core.txt introuvable"
          exit 1
        fi
        
        echo "ðŸ“„ Installation de requirements_core.txt"
        pip install -r requirements_core.txt
        
        if [ -f "requirements_extra.txt" ]; then
          echo "ðŸ“„ Installation de requirements_extra.txt" 
          pip install -r requirements_extra.txt
        else
          echo "â„¹ï¸  Fichier requirements_extra.txt non trouvÃ© - continuation sans"
        fi
        
        echo "âœ… Toutes les dÃ©pendances Python installÃ©es"
        
    - name: ðŸ’¾ Cache output assets
      uses: actions/cache@v3
      with:
        path: |
          output/audio
          output/images
        key: ${{ runner.os }}-assets-${{ github.ref }}-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-assets-${{ github.ref }}-
          ${{ runner.os }}-assets-
        
    - name: ðŸ“ Create output directories
      run: |
        mkdir -p output/videos
        mkdir -p output/audio  
        mkdir -p output/images
        mkdir -p output/logs
        echo "ðŸ“ Dossiers de sortie crÃ©Ã©s"
        
    - name: ðŸ§ª Test system
      run: |
        echo "ðŸ§ª Test du systÃ¨me..."
        python -c "
        try:
            from content_factory.video_creator import VideoCreator
            from content_factory.audio_generator import AudioGenerator  
            from content_factory.image_manager import ImageManager
            print('âœ… Tous les modules importÃ©s avec succÃ¨s')
        except Exception as e:
            print(f'âŒ Erreur import: {e}')
            exit(1)
        "
        
    - name: ðŸ” Check Python syntax
      run: |
        echo "ðŸ” VÃ©rification syntaxe Python..."
        python -m py_compile content_factory/video_creator.py
        python -m py_compile content_factory/audio_generator.py
        python -m py_compile content_factory/image_manager.py
        python -m py_compile content_factory/auto_content_engine.py
        echo "âœ… Tous les fichiers Python sont syntaxiquement valides"
        
    - name: ðŸŽ¬ Create video for current slot
      if: ${{ !inputs.run_all_slots }}
      run: |
        echo "ðŸ•’ DÃ©but production vidÃ©o pour crÃ©neau actuel..."
        python content_factory/auto_content_engine.py
        
    - name: ðŸŽ¬ Create all daily videos  
      if: ${{ inputs.run_all_slots }}
      run: |
        echo "ðŸ•’ DÃ©but production des 4 vidÃ©os quotidiennes..."
        python content_factory/auto_content_engine.py --all
        
    - name: ðŸ’¾ Save assets cache
      if: always()
      uses: actions/cache@v3
      with:
        path: |
          output/audio
          output/images
        key: ${{ runner.os }}-assets-${{ github.ref }}-${{ github.sha }}
        
    - name: ðŸ“¤ Upload video artifacts
      uses: actions/upload-artifact@v4
      with:
        name: youtube-videos-${{ github.run_id }}
        path: output/
        retention-days: 1
        
    - name: ðŸ“Š Show production summary
      if: always()
      run: |
        echo "ðŸ“Š RAPPORT DE PRODUCTION"
        echo "========================"
        echo "ðŸ• Heure: $(date)"
        echo "ðŸƒ Workflow: ${{ github.workflow }}"
        echo "ðŸ”§ Run ID: ${{ github.run_id }}"
        echo ""
        
        echo "ðŸ“¹ VidÃ©os crÃ©Ã©es:"
        video_count=0
        find output/videos -name "*.mp4" -type f 2>/dev/null | while read file; do
          size=$(du -h "$file" | cut -f1)
          echo "   - $(basename "$file") ($size)"
          ((video_count++))
        done
        if [ $video_count -eq 0 ]; then
          echo "   Aucune vidÃ©o trouvÃ©e"
        else
          echo "   Total: $video_count vidÃ©o(s)"
        fi
        
        echo ""
        echo "ðŸ”Š Fichiers audio:"
        audio_count=0
        find output/audio -name "*.mp3" -type f 2>/dev/null | while read file; do
          size=$(du -h "$file" | cut -f1)
          echo "   - $(basename "$file") ($size)"
          ((audio_count++))
        done
        if [ $audio_count -eq 0 ]; then
          echo "   Aucun audio trouvÃ©"
        else
          echo "   Total: $audio_count audio(s)"
        fi
        
        echo ""
        echo "ðŸ–¼ï¸ Images gÃ©nÃ©rÃ©es:"
        image_count=$(find output/images -name "*.jpg" -type f 2>/dev/null | wc -l)
        find output/images -name "*.jpg" -type f 2>/dev/null | head -3 | while read file; do
          echo "   - $(basename "$file")"
        done
        if [ $image_count -gt 3 ]; then
          echo "   ... et $((image_count - 3)) autres"
        fi
        echo "   Total: $image_count images"
        
        echo ""
        echo "ðŸ’¾ Performance & Cache:"
        echo "   âœ… SystÃ¨me de cache activÃ©"
        echo "   âš¡ Temps d'exÃ©cution optimisÃ©"
        echo "   ðŸ”„ Assets rÃ©utilisables entre les runs"
        
    - name: ðŸš¨ Notification on failure
      if: failure()
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'ðŸš¨ YouTube Auto Factory - Production Failed',
            body: `La production vidÃ©o a Ã©chouÃ©. Veuillez vÃ©rifier les logs du workflow.
            
            DÃ©tails:
            - Workflow: ${context.workflow}
            - Run: ${context.runId}
            - Commit: ${context.sha}
            - DÃ©clencheur: ${context.eventName}
            
            Lien vers les logs: https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
          })      run: |
        mkdir -p output/videos
        mkdir -p output/audio  
        mkdir -p output/images
        mkdir -p output/logs
        echo "ðŸ“ Dossiers de sortie crÃ©Ã©s"
        
    - name: ðŸ§ª Test system
      run: |
        echo "ðŸ§ª Test du systÃ¨me..."
        python -c "
        try:
            from content_factory.video_creator import VideoCreator
            from content_factory.audio_generator import AudioGenerator  
            from content_factory.image_manager import ImageManager
            print('âœ… Tous les modules importÃ©s avec succÃ¨s')
        except Exception as e:
            print(f'âŒ Erreur import: {e}')
            exit(1)
        "
        
    - name: ðŸ” Check Python syntax
      run: |
        echo "ðŸ” VÃ©rification syntaxe Python..."
        python -m py_compile content_factory/video_creator.py
        python -m py_compile content_factory/audio_generator.py
        python -m py_compile content_factory/image_manager.py
        python -m py_compile content_factory/auto_content_engine.py
        echo "âœ… Tous les fichiers Python sont syntaxiquement valides"
        
    - name: ðŸŽ¬ Create video for current slot
      if: ${{ !inputs.run_all_slots }}
      run: |
        echo "ðŸ•’ DÃ©but production vidÃ©o pour crÃ©neau actuel..."
        python content_factory/auto_content_engine.py
        
    - name: ðŸŽ¬ Create all daily videos  
      if: ${{ inputs.run_all_slots }}
      run: |
        echo "ðŸ•’ DÃ©but production des 4 vidÃ©os quotidiennes..."
        python content_factory/auto_content_engine.py --all
        
    - name: ðŸ’¾ Save assets cache
      if: always()
      uses: actions/cache@v3
      with:
        path: |
          output/audio
          output/images
        key: ${{ runner.os }}-assets-${{ github.ref }}-${{ github.sha }}
        
    - name: ðŸ“¤ Upload video artifacts
      uses: actions/upload-artifact@v4
      with:
        name: youtube-videos-${{ github.run_id }}
        path: output/
        retention-days: 1
        
    - name: ðŸ“Š Show production summary
      if: always()
      run: |
        echo "ðŸ“Š RAPPORT DE PRODUCTION"
        echo "========================"
        echo "ðŸ• Heure: $(date)"
        echo "ðŸƒ Workflow: ${{ github.workflow }}"
        echo "ðŸ”§ Run ID: ${{ github.run_id }}"
        echo ""
        
        echo "ðŸ“¹ VidÃ©os crÃ©Ã©es:"
        video_count=0
        find output/videos -name "*.mp4" -type f 2>/dev/null | while read file; do
          size=$(du -h "$file" | cut -f1)
          echo "   - $(basename "$file") ($size)"
          ((video_count++))
        done
        if [ $video_count -eq 0 ]; then
          echo "   Aucune vidÃ©o trouvÃ©e"
        else
          echo "   Total: $video_count vidÃ©o(s)"
        fi
        
        echo ""
        echo "ðŸ”Š Fichiers audio:"
        audio_count=0
        find output/audio -name "*.mp3" -type f 2>/dev/null | while read file; do
          size=$(du -h "$file" | cut -f1)
          echo "   - $(basename "$file") ($size)"
          ((audio_count++))
        done
        if [ $audio_count -eq 0 ]; then
          echo "   Aucun audio trouvÃ©"
        else
          echo "   Total: $audio_count audio(s)"
        fi
        
        echo ""
        echo "ðŸ–¼ï¸ Images gÃ©nÃ©rÃ©es:"
        image_count=$(find output/images -name "*.jpg" -type f 2>/dev/null | wc -l)
        find output/images -name "*.jpg" -type f 2>/dev/null | head -3 | while read file; do
          echo "   - $(basename "$file")"
        done
        if [ $image_count -gt 3 ]; then
          echo "   ... et $((image_count - 3)) autres"
        fi
        echo "   Total: $image_count images"
        
        echo ""
        echo "ðŸ’¾ Performance & Cache:"
        echo "   âœ… SystÃ¨me de cache activÃ©"
        echo "   âš¡ Temps d'exÃ©cution optimisÃ©"
        echo "   ðŸ”„ Assets rÃ©utilisables entre les runs"
        
    - name: ðŸš¨ Notification on failure
      if: failure()
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'ðŸš¨ YouTube Auto Factory - Production Failed',
            body: `La production vidÃ©o a Ã©chouÃ©. Veuillez vÃ©rifier les logs du workflow.
            
            DÃ©tails:
            - Workflow: ${context.workflow}
            - Run: ${context.runId}
            - Commit: ${context.sha}
            - DÃ©clencheur: ${context.eventName}
            
            Lien vers les logs: https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
          })
