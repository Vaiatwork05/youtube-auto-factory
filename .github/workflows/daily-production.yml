name: YouTube Auto Factory - 4x Daily

on:
  workflow_dispatch:
    inputs:
      run_all_slots:
        description: 'CrÃ©er les 4 vidÃ©os de la journÃ©e'
        required: false
        default: false
        type: boolean
  schedule:
    # 4 exÃ©cutions par jour : 8h, 12h, 16h, 20h (UTC)
    - cron: '0 6 * * *'   # 8h CEST (6h UTC)
    - cron: '0 10 * * *'  # 12h CEST (10h UTC)
    - cron: '0 14 * * *'  # 16h CEST (14h UTC)
    - cron: '0 18 * * *'  # 20h CEST (18h UTC)

jobs:
  generate-video:
    runs-on: ubuntu-latest
    
    env:
      UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ðŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: ðŸ“¦ Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg espeak espeak-data libespeak-dev
        ffmpeg -version
        espeak --version
        
    - name: ðŸ”§ Install core dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements_core.txt
        
    - name: ðŸ”§ Install extra dependencies
      run: |
        if [ -f "requirements_extra.txt" ]; then
          pip install -r requirements_extra.txt
        else
          echo "âš ï¸  requirements_extra.txt non trouvÃ©, installation des extras manuelle"
          pip install google-api-python-client==2.108.0 || echo "Google API optionnel"
          pip install python-unsplash==1.1.0 || echo "Unsplash optionnel"
        fi
        
    - name: ðŸ§ª Test dependencies
      run: |
        python -c "
        packages = ['moviepy', 'PIL', 'numpy', 'imageio', 'requests', 'edge_tts', 'gtts', 'aiohttp', 'pydub', 'cv2']
        for pkg in packages:
            try:
                if pkg == 'cv2': import cv2
                else: __import__(pkg)
                print(f'âœ… {pkg}')
            except: print(f'âš ï¸  {pkg}')
        "
        
    - name: ðŸ“ Create output directories
      run: |
        mkdir -p output/videos
        mkdir -p output/audio  
        mkdir -p output/images
        mkdir -p output/logs
        echo "ðŸ“ Dossiers crÃ©Ã©s"
        
    - name: ðŸŽ¬ Create video for current slot
      id: create_video
      if: ${{ !inputs.run_all_slots }}
      run: |
        echo "ðŸ•’ DÃ©but production vidÃ©o pour crÃ©neau actuel..."
        python content_factory/auto_content_engine.py
      continue-on-error: true
      
    - name: ðŸŽ¬ Create all daily videos  
      id: create_all_videos
      if: ${{ inputs.run_all_slots }}
      run: |
        echo "ðŸ•’ DÃ©but production des 4 vidÃ©os quotidiennes..."
        python content_factory/auto_content_engine.py --all
      continue-on-error: true
        
    - name: ðŸ“¤ Upload video artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: youtube-videos-${{ github.run_id }}-${{ github.run_attempt }}
        path: |
          output/
        retention-days: 1
        
    - name: ðŸ“Š Show production summary
      if: always()
      run: |
        echo "ðŸ“Š RAPPORT DE PRODUCTION"
        echo "========================"
        echo "ðŸ• Heure: $(date)"
        echo ""
        echo "ðŸ“¹ VidÃ©os crÃ©Ã©es:"
        find output/videos -name "*.mp4" -type f 2>/dev/null | while read file; do
          size=$(du -h "$file" | cut -f1)
          echo "   - $(basename "$file") ($size)"
        done || echo "   Aucune vidÃ©o trouvÃ©e"
        echo ""
        echo "ðŸ”Š Fichiers audio:"
        find output/audio -name "*.mp3" -type f 2>/dev/null | while read file; do
          size=$(du -h "$file" | cut -f1)
          echo "   - $(basename "$file") ($size)"
        done || echo "   Aucun audio trouvÃ©"
        echo ""
        echo "ðŸ–¼ï¸ Images gÃ©nÃ©rÃ©es:"
        find output/images -name "*.jpg" -type f 2>/dev/null | head -5 | while read file; do
          echo "   - $(basename "$file")"
        done
        count=$(find output/images -name "*.jpg" -type f 2>/dev/null | wc -l)
        echo "   Total: $count images"
        
    - name: ðŸš¨ Notification on failure
      if: failure()
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'ðŸš¨ YouTube Auto Factory - Production Failed',
            body: 'La production vidÃ©o a Ã©chouÃ©. Veuillez vÃ©rifier les logs du workflow.'
          })
