name: ğŸš€ GÃ©nÃ©ration VidÃ©o AutomatisÃ©e

on:
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'Activer le mode Debug (crÃ©ation d''images factices)'
        required: false
        type: boolean
        default: false
  schedule:
    - cron: "0 6,12,18 * * *" # 6h00, 12h00, 18h00 UTC

jobs:
  generate-video:
    runs-on: ubuntu-latest
    timeout-minutes: 15 # AugmentÃ© Ã  15 min pour le montage vidÃ©o
    
    steps:
      # Ã‰TAPE 1: RÃ©cupÃ©ration du code source
      - name: ğŸ“¥ Checkout du repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # Ã‰TAPE 2: Configuration de l'environnement Python
      - name: ğŸ Configuration de Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: 'pip'

      # Ã‰TAPE 3: Installation des dÃ©pendances systÃ¨me
      - name: ğŸ“¦ Installation des dÃ©pendances systÃ¨me
        run: |
          sudo apt-get update -y
          # Installation plus propre
          sudo apt-get install -y ffmpeg espeak libespeak1
          echo "âœ… DÃ©pendances systÃ¨me installÃ©es"
      
      # Ã‰TAPE 4: Installation des dÃ©pendances Python
      - name: ğŸ”§ Installation des dÃ©pendances Python
        run: |
          python -m pip install --upgrade pip
          # Utiliser un seul bloc pour l'installation des dÃ©pendances vidÃ©o complÃ¨tes
          # Suppression du "if [ -f requirements.txt ]" pour la clartÃ© de l'exemple
          pip install Pillow numpy requests openai gtts moviepy pydub
          echo "âœ… DÃ©pendances Python installÃ©es"

      # --- Modules Python sont dÃ©sormais codÃ©s dans le dÃ©pÃ´t (bonne pratique) ---
      
      # Ã‰TAPE 5: CrÃ©ation de la structure de dossiers
      - name: ğŸ“ CrÃ©ation de l'arborescence
        run: |
          mkdir -p output/{videos,audio,images,logs}
          echo "âœ… Structure de dossiers crÃ©Ã©e"
      
      # Ã‰TAPE 6: Exportation des secrets (meilleure pratique)
      - name: ğŸ”‘ Exportation des secrets
        run: |
          echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> $GITHUB_ENV
          echo "DEBUG_MODE=${{ github.event.inputs.debug_mode }}" >> $GITHUB_ENV
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

      # Ã‰TAPE 7: ExÃ©cution de la gÃ©nÃ©ration
      - name: ğŸ¬ ExÃ©cution du Moteur de Contenu
        run: |
          echo "ğŸ¬ LANCEMENT DE LA GÃ‰NÃ‰RATION..."
          python content_factory/main_engine.py
        env:
          # Assurez-vous que les variables d'environnement sont disponibles ici aussi
          DEBUG_MODE: ${{ github.event.inputs.debug_mode }}

      # Ã‰TAPE 8: Sauvegarde des rÃ©sultats
      - name: ğŸ’¾ Sauvegarde des artefacts
        uses: actions/upload-artifact@v4
        with:
          name: generation-resultats-${{ github.sha }}
          path: |
            output/
          retention-days: 2
          if-no-files-found: warn

      # Ã‰TAPE 9: Rapport final
      - name: ğŸ“Š Rapport final
        if: always()
        run: |
          echo " "
          echo "ğŸ“Š RAPPORT FINAL DE GÃ‰NÃ‰RATION"
          echo "================================"
          # Afficher si le fichier rapport principal existe
          if [ -f "output/logs/rapport_generation.txt" ]; then
            cat output/logs/rapport_generation.txt
          else
            echo "âš ï¸ Fichier rapport introuvable."
            echo "VÃ©rifiez les logs d'erreur dans output/logs/."
          fi
