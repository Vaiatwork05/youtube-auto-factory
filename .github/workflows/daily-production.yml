# Workflow final optimisÃ© pour la production quotidienne.

name: ğŸš€ Production - Lancement Quotidien du Moteur

# ===============================================
# DÃ‰CLENCHEURS
# ===============================================
on:
  # DÃ©clenche le workflow Ã  06h, 10h, 14h et 18h UTC
  schedule:
    - cron: '0 6,10,14,18 * * *' 
  
  # Lancement Manuel pour le test
  workflow_dispatch:
    inputs:
      force_run:
        description: 'Forcer l''exÃ©cution du Slot 1 (premier crÃ©neau) pour un test immÃ©diat.'
        required: true
        default: 'false'
        type: boolean
        
permissions:
  contents: read 
  
jobs:
  daily_production_job:
    
    # âš ï¸ Utilisation d'un conteneur avec FFMPEG. Si ce conteneur Ã©choue,
    # essayez python:3.11-slim-buster et ajoutez 'sudo apt-get install ffmpeg' dans l'Ã©tape 2.
    container:
      image: jrottenberg/ffmpeg:4.4-python3.11 
      
    runs-on: ubuntu-latest
    
    # ===============================================
    # VARIABLES D'ENVIRONNEMENT GLOBALES
    # ===============================================
    env:
      FORCE_RUN: ${{ github.event.inputs.force_run || 'false' }} 
      ENGINE_SCRIPT: 'content_factory/auto_content_engine.py'
      OUTPUT_ROOT: 'output' 
      
      # ğŸ”‘ INJECTION DES SECRETS (Configuration des modules Python)
      UNSPLASH_API_KEY: ${{ secrets.UNSPLASH_API_KEY }}
      YOUTUBE_CLIENT_ID: ${{ secrets.YOUTUBE_CLIENT_ID }}
      YOUTUBE_CLIENT_SECRET: ${{ secrets.YOUTUBE_CLIENT_SECRET }}
      YOUTUBE_REFRESH_TOKEN: ${{ secrets.YOUTUBE_REFRESH_TOKEN }}
      
    steps:
    
    # â¬‡ï¸ Ã‰TAPE 1: Initialisation
    - name: â¬‡ï¸ Checkout du code
      uses: actions/checkout@v4
      with:
        path: app 
    
    # ğŸ“¦ Ã‰TAPE 2: Installation des dÃ©pendances Python
    - name: ğŸ“¦ PrÃ©paration de l'environnement et VÃ©rification
      working-directory: ./app 
      run: |
        echo "==========================================="
        echo "## ğŸ“¦ DÃ©marrage de la PrÃ©paration de l'Environnement"
        echo "## RÃ©pertoire de travail actuel: $(pwd)"
        echo "==========================================="
        
        # Mise Ã  jour et vÃ©rification de PIP
        echo "-> Mise Ã  jour de pip et setuptools..."
        python -m pip install --upgrade pip setuptools
        python -m pip --version
        
        # Installation des librairies
        echo "-> Installation des dÃ©pendances depuis requirements.txt..."
        pip install -r requirements.txt 
        
        # Log de vÃ©rification pour s'assurer que FFMPEG est disponible
        echo "-> VÃ©rification de l'outil FFMPEG (via le conteneur)..."
        ffmpeg -version | head -n 1
        
        echo "## âœ… PrÃ©paration de l'environnement terminÃ©e."
        
    # ğŸš€ Ã‰TAPE 3: ExÃ©cution du Moteur (Production)
    - name: ğŸš€ Lancement du Moteur de Contenu
      working-directory: ./app
      run: |
        echo "========================================================================================================="
        echo "## ğŸš€ DÃ©marrage de l'ExÃ©cution du Moteur"
        echo "## Script: ${{ env.ENGINE_SCRIPT }}"
        echo "## Argument --force-run: ${{ env.FORCE_RUN }}"
        echo "## Heure de lancement UTC: $(date -u)"
        echo "========================================================================================================="
        
        # VÃ©rification des variables d'environnement (pour confirmer qu'elles sont chargÃ©es)
        echo "-> VÃ©rification des variables critiques: ENGINE_SCRIPT=${{ env.ENGINE_SCRIPT }}"
        
        # ExÃ©cution du moteur Python avec l'argument --force-run
        echo "-> Commande exÃ©cutÃ©e: python '${{ env.ENGINE_SCRIPT }}' --force-run ${{ env.FORCE_RUN }}"
        python "${{ env.ENGINE_SCRIPT }}" --force-run ${{ env.FORCE_RUN }}
        
        # Log aprÃ¨s l'exÃ©cution
        echo "## âœ… ExÃ©cution du script terminÃ©e. VÃ©rification du statut de sortie..."
        
    # ğŸ’¾ Ã‰TAPE 4: Sauvegarde des artefacts
    - name: ğŸ’¾ Sauvegarde des Artefacts de gÃ©nÃ©ration
      uses: actions/upload-artifact@v4
      if: always() 
      with:
        name: resultats-${{ github.run_id }}
        path: app/${{ env.OUTPUT_ROOT }} 
        retention-days: 7 
      run: |
        echo "## ğŸ’¾ VÃ©rification du dossier des artefacts: app/${{ env.OUTPUT_ROOT }}"
        # Liste le contenu du rÃ©pertoire de sortie pour confirmer que des fichiers existent
        ls -R app/${{ env.OUTPUT_ROOT }} || echo "âš ï¸ Le dossier de sortie est vide ou n'existe pas."
        
    # ğŸ”” Ã‰TAPE 5: Notifications
    - name: ğŸ”” Notification de SuccÃ¨s
      if: success()
      run: |
        echo "==========================================="
        echo "ğŸ‰ Le workflow de production s'est terminÃ© avec succÃ¨s !"
        echo "==========================================="
        
    - name: ğŸ”” Notification d'Ã‰chec
      if: failure()
      run: |
        echo "==========================================="
        echo "âŒ Ã‰CHEC CRITIQUE: Le workflow de production a Ã©chouÃ©."
        echo "âŒ Veuillez consulter les logs des Ã©tapes prÃ©cÃ©dentes pour diagnostiquer le problÃ¨me."
        echo "==========================================="
