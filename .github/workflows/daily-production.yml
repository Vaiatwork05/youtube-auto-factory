# .github/workflows/daily-production.yml
# Workflow final optimisÃ© pour la production quotidienne.

name: ğŸš€ Production - Lancement Quotidien du Moteur

# ===============================================
# DÃ‰CLENCHEURS
# ===============================================
on:
  # DÃ©clenche le workflow Ã  06h, 10h, 14h et 18h UTC
  schedule:
    - cron: '0 6,10,14,18 * * *' 
  
  # Lancement Manuel pour le test
  workflow_dispatch:
    inputs:
      force_run:
        description: 'Forcer l''exÃ©cution du Slot 1 (premier crÃ©neau) pour un test immÃ©diat.'
        required: true
        default: 'false'
        type: boolean
        
permissions:
  contents: read 
  
jobs:
  
  # ===============================================
  # JOB 1: ExÃ©cution du Moteur (OptimisÃ© avec Cache)
  # ===============================================
  engine_run:
    runs-on: ubuntu-latest
    
    # VARIABLES D'ENVIRONNEMENT GLOBALES
    env:
      FORCE_RUN: ${{ github.event.inputs.force_run || 'false' }} 
      ENGINE_SCRIPT: 'content_factory.auto_content_engine' # ModifiÃ© pour le mode module
      OUTPUT_ROOT: 'output' 
      
      # Assure que le rÃ©pertoire parent est dans PYTHONPATH pour les imports (Correction d'ImportError)
      PYTHONPATH: ${{ github.workspace }}/app
      
      # ğŸ”‘ INJECTION DES SECRETS
      UNSPLASH_API_KEY: ${{ secrets.UNSPLASH_API_KEY }}
      YOUTUBE_CLIENT_ID: ${{ secrets.YOUTUBE_CLIENT_ID }}
      YOUTUBE_CLIENT_SECRET: ${{ secrets.YOUTUBE_CLIENT_SECRET }}
      YOUTUBE_REFRESH_TOKEN: ${{ secrets.YOUTUBE_REFRESH_TOKEN }}
      
    steps:
      
      # â¬‡ï¸ Ã‰TAPE 1: Checkout du code
      - name: â¬‡ï¸ Checkout du code
        uses: actions/checkout@v4
        with:
          path: app 
          
      # ğŸ’¾ NOUVELLE Ã‰TAPE: Cache des dÃ©pendances Python (pour accÃ©lÃ©rer les runs)
      - name: ğŸ’¾ Cache des dÃ©pendances Python
        uses: actions/cache@v4
        with:
          # Le chemin oÃ¹ l'environnement virtuel est crÃ©Ã©
          path: app/venv 
          # La clÃ© change si le contenu de requirements.txt change
          key: ${{ runner.os }}-pip-${{ hashFiles('app/requirements.txt') }}
          # Permet de rÃ©cupÃ©rer une version antÃ©rieure du cache si la clÃ© principale ne matche pas
          restore-keys: |
            ${{ runner.os }}-pip-

      # ğŸ“¦ Ã‰TAPE 2: PrÃ©paration, Installation de FFMPEG et DÃ©pendances Python
      - name: ğŸ“¦ PrÃ©paration de l'environnement et Installation de FFMPEG
        working-directory: ./app 
        run: |
          echo "==========================================="
          echo "## ğŸ“¦ DÃ©marrage de la PrÃ©paration de l'Environnement"
          echo "==========================================="
          
          # Installation de FFMPEG sur l'hÃ´te Ubuntu
          echo "-> Installation du paquet FFMPEG..."
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          
          # --- Installation des dÃ©pendances Python (avec ou sans cache) ---
          echo "-> Configuration de l'environnement virtuel (Venv)..."
          python3 -m venv venv
          source venv/bin/activate
          
          # â­ Auto-update pip
          echo "-> Auto-mise Ã  jour de pip..."
          pip install --upgrade pip setuptools

          echo "-> Installation des dÃ©pendances Python (via cache ou tÃ©lÃ©chargement)..."
          pip install -r requirements.txt 
          
          echo "## âœ… PrÃ©paration de l'environnement terminÃ©e."
          
      # ğŸš€ Ã‰TAPE 3: ExÃ©cution du Moteur (Mode Module)
      - name: ğŸš€ Lancement du Moteur de Contenu
        working-directory: ./app
        run: |
          # Activation de l'environnement virtuel pour exÃ©cuter le script
          source venv/bin/activate
          
          echo "========================================================================================================="
          echo "## ğŸš€ DÃ©marrage de l'ExÃ©cution du Moteur (Mode Module)"
          echo "========================================================================================================="
          
          # ExÃ©cution en tant que module (Correction d'ImportError)
          MODULE_PATH="content_factory.auto_content_engine"
          
          echo "-> Commande exÃ©cutÃ©e: python -m ${MODULE_PATH} --force-run ${{ env.FORCE_RUN }}"
          python -m "${MODULE_PATH}" --force-run ${{ env.FORCE_RUN }}
          
          echo "## âœ… ExÃ©cution du script terminÃ©e."
          
      # ğŸ’¾ Ã‰TAPE 4 (a): Log et vÃ©rification des artefacts
      - name: ğŸ’¾ VÃ©rification des Artefacts avant Upload
        if: always() 
        run: |
          echo "## ğŸ’¾ VÃ©rification du dossier des artefacts: app/${{ env.OUTPUT_ROOT }}"
          ls -R app/${{ env.OUTPUT_ROOT }} || echo "âš ï¸ Le dossier de sortie est vide ou n'existe pas."

      # ğŸ’¾ Ã‰TAPE 4 (b): Sauvegarde des artefacts (Upload)
      - name: â¬†ï¸ Upload des Artefacts de gÃ©nÃ©ration
        uses: actions/upload-artifact@v4
        if: always() 
        with:
          name: resultats-${{ github.run_id }}
          path: app/${{ env.OUTPUT_ROOT }} 
          retention-days: 7 
          
  # ===============================================
  # JOB 2: Notifications (S'exÃ©cute toujours pour le rapport)
  # ===============================================
  notification_job:
    runs-on: ubuntu-latest
    needs: engine_run 
    if: always()
    
    steps:
      # ğŸ”” Notification de SuccÃ¨s
      - name: ğŸ”” Notification de SuccÃ¨s
        if: success() && needs.engine_run.result == 'success'
        run: |
          echo "==========================================="
          echo "ğŸ‰ Le workflow de production s'est terminÃ© avec succÃ¨s !"
          echo "==========================================="
          
      # ğŸ”” Notification d'Ã‰chec
      - name: ğŸ”” Notification d'Ã‰chec
        if: failure() || needs.engine_run.result == 'failure'
        run: |
          echo "==========================================="
          echo "âŒ Ã‰CHEC CRITIQUE: Le workflow de production a Ã©chouÃ©."
          echo "âŒ Veuillez consulter les logs du Job 'engine_run' pour diagnostiquer le problÃ¨me."
          echo "==========================================="
