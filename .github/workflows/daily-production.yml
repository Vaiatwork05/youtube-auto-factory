Name: ðŸš€ GÃ©nÃ©ration VidÃ©o AutomatisÃ©e

on:
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'Activer le mode Debug (crÃ©ation d''images factices)'
        required: false
        type: boolean
        default: false
  schedule:
    - cron: "0 6,12,18 * * *" # 6h00, 12h00, 18h00 UTC

jobs:
  generate-video:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      # Ã‰TAPE 1: RÃ©cupÃ©ration du code source
      - name: ðŸ“¥ Checkout du repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # Ã‰TAPE 2: Configuration de l'environnement Python
      - name: ðŸ Configuration de Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: 'pip'

      # Ã‰TAPE 3: Installation des dÃ©pendances systÃ¨me
      - name: ðŸ“¦ Installation des dÃ©pendances systÃ¨me
        run: |
          sudo apt-get update -y
          sudo apt-get install -y ffmpeg espeak libespeak1
          echo "âœ… DÃ©pendances systÃ¨me installÃ©es"
      
      # Ã‰TAPE 4: Installation des dÃ©pendances Python
      - name: ðŸ”§ Installation des dÃ©pendances Python
        run: |
          python -m pip install --upgrade pip
          pip install Pillow numpy requests openai gtts moviepy pydub
          echo "âœ… DÃ©pendances Python installÃ©es"

      # Ã‰TAPE 5: CrÃ©ation de la structure de dossiers
      - name: ðŸ“ CrÃ©ation de l'arborescence
        run: |
          mkdir -p output/{videos,audio,images,logs}
          mkdir -p scripts # Ajout pour le nouveau script
          echo "âœ… Structure de dossiers crÃ©Ã©e"
      
      # Ã‰TAPE 6: VÃ©rification des fichiers existants
      - name: ðŸ” VÃ©rification des composants
        run: |
          echo "ðŸ” VÃ©rification des fichiers content_factory..."
          echo "ðŸ“ Contenu du dossier content_factory/:"
          ls -la content_factory/
          echo " "
          
          # Test des imports Python (Syntaxe correcte car simple)
          python3 -c "
try:
    from content_factory.image_manager import ImageManager
    from content_factory.audio_generator import AudioGenerator  
    from content_factory.video_creator import VideoCreator
    from content_factory.content_generator import ContentGenerator
    from content_factory.auto_content_engine import main
    print('âœ… Tous les imports fonctionnent')
except Exception as e:
    print(f'âŒ Erreur import: {e}')
    exit(1)
          "
          echo "âœ… Tous les composants sont opÃ©rationnels"

      # Ã‰TAPE 7: DÃ©sactivation YouTube Uploader si nÃ©cessaire
      # CORRECTION APPLIQUÃ‰E ICI : Appel direct du script Python
      - name: ðŸš« DÃ©sactivation YouTube Uploader via script
        run: python3 scripts/disable_youtube_uploader.py

      # Ã‰TAPE 8: Configuration de l'environnement
      - name: ðŸ”‘ Configuration des variables
        run: |
          echo "DEBUG_MODE=${{ github.event.inputs.debug_mode || 'false' }}" >> $GITHUB_ENV
          echo "âœ… Variables d'environnement configurÃ©es"

      # Ã‰TAPE 9: ExÃ©cution de la gÃ©nÃ©ration
      - name: ðŸŽ¬ ExÃ©cution du Moteur de Contenu
        run: |
          echo "ðŸŽ¬ LANCEMENT DE LA GÃ‰NÃ‰RATION..."
          echo "ðŸ“œ Utilisation de: content_factory/auto_content_engine.py"
          echo "ðŸ”§ Mode Debug: $DEBUG_MODE"
          
          # VÃ©rifier que le fichier existe
          if [ -f "content_factory/auto_content_engine.py" ]; then
            python content_factory/auto_content_engine.py
          else
            echo "âŒ Fichier auto_content_engine.py non trouvÃ©"
            echo "ðŸ“‹ Fichiers disponibles:"
            find content_factory/ -name "*.py" | head -10
            exit 1
          fi

      # Ã‰TAPE 10: Sauvegarde des rÃ©sultats
      - name: ðŸ’¾ Sauvegarde des artefacts
        uses: actions/upload-artifact@v4
        with:
          name: generation-resultats-${{ github.sha }}
          path: |
            output/
          retention-days: 2
          if-no-files-found: warn

      # Ã‰TAPE 11: Rapport final dÃ©taillÃ©
      - name: ðŸ“Š Rapport final
        if: always()
        run: |
          echo " "
          echo "ðŸ“Š RAPPORT FINAL DE GÃ‰NÃ‰RATION"
          echo "================================"
          echo "ðŸƒ Workflow: $GITHUB_WORKFLOW"
          echo "ðŸ“… ExÃ©cution: $(date)"
          echo "ðŸ”§ Mode Debug: $DEBUG_MODE"
          echo " "
          
          echo "ðŸ“ CONTENU GÃ‰NÃ‰RÃ‰:"
          echo "------------------"
          for dossier in videos audio images logs; do
            if [ -d "output/$dossier" ]; then
              count=$(find "output/$dossier" -type f 2>/dev/null | wc -l)
              echo "ðŸ“‚ output/$dossier: $count fichiers"
            else
              echo "ðŸ“‚ output/$dossier: dossier non trouvÃ©"
            fi
          done
          
          echo " "
          echo "ðŸ” FICHIERS DÃ‰TAILLÃ‰S:"
          echo "---------------------"
          find output/ -type f 2>/dev/null | while read file; do
            size=$(du -h "$file" 2>/dev/null | cut -f1 | head -1 || echo "0K")
            echo "ðŸ“„ $(basename "$file") ($size)"
          done || echo "Aucun fichier trouvÃ© dans output/"
          
          echo " "
          if [ -f "output/logs/rapport_generation.txt" ]; then
            echo "ðŸ“‹ RAPPORT PRINCIPAL:"
            echo "-------------------"
            cat output/logs/rapport_generation.txt
          fi
          
          echo " "
          echo "ðŸŽ‰ PROCESSUS TERMINÃ‰ !"
