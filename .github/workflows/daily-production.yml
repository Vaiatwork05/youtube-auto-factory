# .github/workflows/daily-production.yml

name: ğŸš€ Production - Lancement Quotidien du Moteur

# ... (DÃ©clencheurs et Permissions restent inchangÃ©s)
on:
  schedule:
    - cron: '0 6,10,14,18 * * *' 
  workflow_dispatch:
    inputs:
      force_run:
        description: 'Forcer l''exÃ©cution du Slot 1 (premier crÃ©neau) pour un test immÃ©diat.'
        required: true
        default: 'false'
        type: boolean
        
permissions:
  contents: read 
  
jobs:
  
  # ===============================================
  # JOB 1: ExÃ©cution du Moteur (NÃ©cessite le Conteneur)
  # ===============================================
  engine_run:
    runs-on: ubuntu-latest
    
    # DÃ©finition du conteneur POUR CE JOB
    container:
      image: jrottenberg/ffmpeg:4.4-python3.11 
      
    # Variables d'environnement pour ce Job (inchangÃ©es)
    env:
      FORCE_RUN: ${{ github.event.inputs.force_run || 'false' }} 
      ENGINE_SCRIPT: 'content_factory/auto_content_engine.py'
      OUTPUT_ROOT: 'output' 
      UNSPLASH_API_KEY: ${{ secrets.UNSPLASH_API_KEY }}
      YOUTUBE_CLIENT_ID: ${{ secrets.YOUTUBE_CLIENT_ID }}
      YOUTUBE_CLIENT_SECRET: ${{ secrets.YOUTUBE_CLIENT_SECRET }}
      YOUTUBE_REFRESH_TOKEN: ${{ secrets.YOUTUBE_REFRESH_TOKEN }}
      
    steps:
      # â¬‡ï¸ Ã‰TAPE 1: Checkout
      - name: â¬‡ï¸ Checkout du code
        uses: actions/checkout@v4
        with:
          path: app 
      
      # ğŸ“¦ Ã‰TAPE 2: Installation des dÃ©pendances Python
      - name: ğŸ“¦ PrÃ©paration de l'environnement
        working-directory: ./app 
        run: |
          # ... (Logs d'installation)
          python -m pip install --upgrade pip setuptools
          pip install -r requirements.txt 
          ffmpeg -version | head -n 1
          
      # ğŸš€ Ã‰TAPE 3: ExÃ©cution du Moteur (C'est ici que l'Ã©chec peut se produire)
      - name: ğŸš€ Lancement du Moteur de Contenu
        working-directory: ./app
        id: engine_execution # Ajout d'un ID pour la rÃ©fÃ©rence future
        run: |
          # ... (Logs d'exÃ©cution)
          python "${{ env.ENGINE_SCRIPT }}" --force-run ${{ env.FORCE_RUN }}

          # VÃ©rifiez si le script a produit des fichiers pour l'upload
          ls -R app/${{ env.OUTPUT_ROOT }} 2>/dev/null >/dev/null
          if [ $? -eq 0 ]; then
            echo "::set-output name=files_produced::true"
          else
            echo "::set-output name=files_produced::false"
          fi
          
      # ğŸ’¾ Ã‰TAPE 4: Sauvegarde des artefacts (Upload effectif)
      - name: â¬†ï¸ Upload des Artefacts de gÃ©nÃ©ration
        uses: actions/upload-artifact@v4
        if: always() # Upload mÃªme si le script Python Ã©choue
        with:
          name: resultats-${{ github.run_id }}
          path: app/${{ env.OUTPUT_ROOT }} 
          retention-days: 7 
          
  # ===============================================
  # JOB 2: Notifications et Logs de Fin (SANS conteneur)
  # ===============================================
  notification_job:
    runs-on: ubuntu-latest
    needs: engine_run # DÃ©pend du Job d'exÃ©cution du moteur
    if: always() # S'exÃ©cute toujours, mÃªme si engine_run Ã©choue
    
    steps:
      # ğŸ”” Notification de SuccÃ¨s
      - name: ğŸ”” Notification de SuccÃ¨s
        if: success() && needs.engine_run.result == 'success'
        run: |
          echo "==========================================="
          echo "ğŸ‰ Le workflow de production s'est terminÃ© avec succÃ¨s !"
          echo "==========================================="
          
      # ğŸ”” Notification d'Ã‰chec
      - name: ğŸ”” Notification d'Ã‰chec
        if: failure() || needs.engine_run.result == 'failure'
        run: |
          echo "==========================================="
          echo "âŒ Ã‰CHEC CRITIQUE: Le workflow de production a Ã©chouÃ©."
          echo "âŒ Veuillez consulter les logs du Job 'engine_run' pour diagnostiquer le problÃ¨me."
          echo "==========================================="
