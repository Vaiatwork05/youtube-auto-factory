name: 🚀 ULTIME - Génération Vidéo

on:
  workflow_dispatch:
  schedule:
    - cron: "0 6 * * *"   # 8h CEST
    - cron: "0 10 * * *"  # 12h CEST
    - cron: "0 14 * * *"  # 16h CEST
    - cron: "0 18 * * *"  # 20h CEST

jobs:
  generate-video:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v4

      - name: 🐍 Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: 📦 Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg espeak

      - name: 🔧 Install Python dependencies
        run: |
          pip install -r requirements.txt

      - name: 📁 Create output directories
        run: |
          mkdir -p output/videos output/audio output/images output/logs

      - name: 🔧 Corriger ImageManager
        run: |
          echo "🔧 Vérification/correction ImageManager..."
          # S'assurer que image_manager.py a une classe ImageManager
          if grep -q "class ImageManager" content_factory/image_manager.py; then
            echo "✅ ImageManager existe déjà"
          else
            echo "📝 Ajout de ImageManager..."
            cat >> content_factory/image_manager.py << 'EOF'

class ImageManager:
    def __init__(self):
        self.image_dir = "output/images"
        os.makedirs(self.image_dir, exist_ok=True)
    
    def get_images_for_content(self, content_data, num_images=6):
        """Récupère des images pour le contenu"""
        print("🖼️  Récupération d'images...")
        images = []
        for i in range(num_images):
            img_path = os.path.join(self.image_dir, f"image_{i}.jpg")
            # Créer une image simple
            from PIL import Image, ImageDraw, ImageFont
            img = Image.new('RGB', (1280, 720), color=(i*40, 100, 150))
            draw = ImageDraw.Draw(img)
            img.save(img_path)
            images.append(img_path)
        return images
EOF
          fi

      - name: 🔧 Désactiver YouTube Upload
        run: |
          echo "🔧 Désactivation YouTube Upload..."
          sed -i 's/^from youtube_uploader import YouTubeUploader/# from youtube_uploader import YouTubeUploader  # Désactivé temporairement/' content_factory/auto_content_engine.py
          echo "✅ YouTube Upload désactivé"

      - name: 🧪 Test final
        run: |
          echo "🧪 Test final avant génération..."
          python -c "
          try:
              from content_factory.image_manager import ImageManager
              mgr = ImageManager()
              print('✅ ImageManager fonctionne')
              
              from content_factory.audio_generator import AudioGenerator
              audio = AudioGenerator()
              print('✅ AudioGenerator fonctionne')
              
              from content_factory.video_creator import VideoCreator
              video = VideoCreator()
              print('✅ VideoCreator fonctionne')
              
              print('🎉 SYSTÈME PRÊT !')
          except Exception as e:
              print(f'❌ Erreur: {e}')
              exit(1)
          "

      - name: 🎬 Générer la vidéo
        run: |
          echo "🎬 LANCEMENT DE LA GÉNÉRATION VIDÉO..."
          python content_factory/auto_content_engine.py

      - name: 📤 Télécharger les résultats
        uses: actions/upload-artifact@v4
        with:
          name: videos-generées
          path: output/
          retention-days: 1

      - name: 📊 Rapport final
        if: always()
        run: |
          echo "📊 RAPPORT FINAL"
          echo "================"
          echo "📹 Vidéos: $(find output/videos -name '*.mp4' 2>/dev/null | wc -l)"
          echo "🔊 Audios: $(find output/audio -name '*.mp3' 2>/dev/null | wc -l)"
          echo "🖼️ Images: $(find output/images -name '*.jpg' 2>/dev/null | wc -l)"
          echo "🎉 GÉNÉRATION TERMINÉE !"
