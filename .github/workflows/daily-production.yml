name: ðŸš€ ULTIME - GÃ©nÃ©ration VidÃ©o

on:
  workflow_dispatch:
  schedule:
    - cron: "0 6 * * *"   # 8h CEST
    - cron: "0 10 * * *"  # 12h CEST
    - cron: "0 14 * * *"  # 16h CEST
    - cron: "0 18 * * *"  # 20h CEST

jobs:
  generate-video:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: ðŸ“¦ Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg espeak

      - name: ðŸ”§ Install Python dependencies
        run: |
          pip install -r requirements.txt

      - name: ðŸ“ Create output directories
        run: |
          mkdir -p output/videos output/audio output/images output/logs

      - name: ðŸ”§ Corriger ImageManager (mÃ©thode Python)
        run: |
          echo "ðŸ”§ VÃ©rification/correction ImageManager..."
          python3 -c "
          import os
          
          # VÃ©rifier si ImageManager existe dÃ©jÃ 
          with open('content_factory/image_manager.py', 'r') as f:
              content = f.read()
          
          if 'class ImageManager' in content:
              print('âœ… ImageManager existe dÃ©jÃ ')
          else:
              print('ðŸ“ Ajout de ImageManager...')
              new_content = content + '''

class ImageManager:
    def __init__(self):
        self.image_dir = \"output/images\"
        os.makedirs(self.image_dir, exist_ok=True)
    
    def get_images_for_content(self, content_data, num_images=6):
        \"\"\"RÃ©cupÃ¨re des images pour le contenu\"\"\"
        print(\"ðŸ–¼ï¸  RÃ©cupÃ©ration d'images...\")
        images = []
        for i in range(num_images):
            img_path = os.path.join(self.image_dir, f\"image_{i}.jpg\")
            # CrÃ©er une image simple
            from PIL import Image, ImageDraw, ImageFont
            img = Image.new('RGB', (1280, 720), color=(i*40, 100, 150))
            draw = ImageDraw.Draw(img)
            img.save(img_path)
            images.append(img_path)
        return images
'''
              with open('content_factory/image_manager.py', 'w') as f:
                  f.write(new_content)
              print('âœ… ImageManager ajoutÃ©')
          "

      - name: ðŸ”§ DÃ©sactiver YouTube Upload (mÃ©thode Python)
        run: |
          echo "ðŸ”§ DÃ©sactivation YouTube Upload avec Python..."
          python3 -c "
          # Lire le fichier
          with open('content_factory/auto_content_engine.py', 'r') as f:
              lines = f.readlines()
          
          # Remplacer la ligne problÃ©matique
          new_lines = []
          for line in lines:
              if line.strip().startswith('from youtube_uploader import YouTubeUploader'):
                  new_lines.append('# from youtube_uploader import YouTubeUploader  # DÃ©sactivÃ© temporairement\n')
              else:
                  new_lines.append(line)
          
          # RÃ©Ã©crire le fichier
          with open('content_factory/auto_content_engine.py', 'w') as f:
              f.writelines(new_lines)
          
          print('âœ… YouTube Upload dÃ©sactivÃ©')
          "

      - name: ðŸ§ª Test final
        run: |
          echo "ðŸ§ª Test final avant gÃ©nÃ©ration..."
          python -c "
          try:
              from content_factory.image_manager import ImageManager
              mgr = ImageManager()
              print('âœ… ImageManager fonctionne')
              
              from content_factory.audio_generator import AudioGenerator
              audio = AudioGenerator()
              print('âœ… AudioGenerator fonctionne')
              
              from content_factory.video_creator import VideoCreator
              video = VideoCreator()
              print('âœ… VideoCreator fonctionne')
              
              print('ðŸŽ‰ SYSTÃˆME PRÃŠT !')
          except Exception as e:
              print(f'âŒ Erreur: {e}')
              exit(1)
          "

      - name: ðŸŽ¬ GÃ©nÃ©rer la vidÃ©o
        run: |
          echo "ðŸŽ¬ LANCEMENT DE LA GÃ‰NÃ‰RATION VIDÃ‰O..."
          python content_factory/auto_content_engine.py

      - name: ðŸ“¤ TÃ©lÃ©charger les rÃ©sultats
        uses: actions/upload-artifact@v4
        with:
          name: videos-generÃ©es
          path: output/
          retention-days: 1

      - name: ðŸ“Š Rapport final
        if: always()
        run: |
          echo "ðŸ“Š RAPPORT FINAL"
          echo "================"
          echo "ðŸ“¹ VidÃ©os: $(find output/videos -name '*.mp4' 2>/dev/null | wc -l)"
          echo "ðŸ”Š Audios: $(find output/audio -name '*.mp3' 2>/dev/null | wc -l)"
          echo "ðŸ–¼ï¸ Images: $(find output/images -name '*.jpg' 2>/dev/null | wc -l)"
          echo "ðŸŽ‰ GÃ‰NÃ‰RATION TERMINÃ‰E !"
