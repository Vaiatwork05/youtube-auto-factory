# .github/workflows/daily-production.yml
# Workflow final optimisé pour la production quotidienne.

name: 🚀 Production - Lancement Quotidien du Moteur

# ===============================================
# DÉCLENCHEURS
# ===============================================
on:
  # Déclenche le workflow à 06h, 10h, 14h et 18h UTC
  schedule:
    - cron: '0 6,10,14,18 * * *' 
  
  # Lancement Manuel pour le test
  workflow_dispatch:
    inputs:
      force_run:
        description: 'Forcer l''exécution du Slot 1 (premier créneau) pour un test immédiat.'
        required: true
        default: 'false'
        type: boolean
        
permissions:
  contents: read 
  
jobs:
  
  # ===============================================
  # JOB 1: Exécution du Moteur (SANS Conteneur Docker)
  # ===============================================
  engine_run:
    runs-on: ubuntu-latest
    
    # NOTE: Le bloc 'container:' a été retiré pour éviter l'erreur 'ContainerId'. FFMPEG est installé manuellement dans l'Étape 2.
    
    # VARIABLES D'ENVIRONNEMENT GLOBALES
    env:
      FORCE_RUN: ${{ github.event.inputs.force_run || 'false' }} 
      ENGINE_SCRIPT: 'content_factory/auto_content_engine.py'
      OUTPUT_ROOT: 'output' 
      
      # 🔑 INJECTION DES SECRETS
      UNSPLASH_API_KEY: ${{ secrets.UNSPLASH_API_KEY }}
      YOUTUBE_CLIENT_ID: ${{ secrets.YOUTUBE_CLIENT_ID }}
      YOUTUBE_CLIENT_SECRET: ${{ secrets.YOUTUBE_CLIENT_SECRET }}
      YOUTUBE_REFRESH_TOKEN: ${{ secrets.YOUTUBE_REFRESH_TOKEN }}
      
    steps:
      
      # ⬇️ ÉTAPE 1: Checkout du code
      - name: ⬇️ Checkout du code
        uses: actions/checkout@v4
        with:
          path: app 
      
      # 📦 ÉTAPE 2: Préparation, Installation de FFMPEG et Dépendances Python
      - name: 📦 Préparation de l'environnement et Installation de FFMPEG
        working-directory: ./app 
        run: |
          echo "==========================================="
          echo "## 📦 Démarrage de la Préparation de l'Environnement"
          echo "==========================================="
          
          # --- INSTALLATION DE FFMPEG SUR L'HÔTE UBUNTU ---
          echo "-> Installation du paquet FFMPEG..."
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          
          # Mise à jour et installation des dépendances Python
          echo "-> Mise à jour de pip et installation des dépendances Python..."
          python -m pip install --upgrade pip setuptools
          pip install -r requirements.txt 
          
          echo "## ✅ Préparation de l'environnement terminée."
          
      # 🚀 ÉTAPE 3: Exécution du Moteur (avec Correction d'Import)
      - name: 🚀 Lancement du Moteur de Contenu
        working-directory: ./app
        run: |
          echo "========================================================================================================="
          echo "## 🚀 Démarrage de l'Exécution du Moteur"
          echo "## Script: ${{ env.ENGINE_SCRIPT }}"
          echo "## Argument --force-run: ${{ env.FORCE_RUN }}"
          echo "========================================================================================================="
          
          # --- CORRECTION DE L'IMPORTERROR ---
          # Ajoute le répertoire de travail actuel (./app) au PYTHONPATH pour les imports relatifs.
          export PYTHONPATH=$PYTHONPATH:$(pwd)
          
          # Exécution du moteur Python
          echo "-> Commande exécutée: python '${{ env.ENGINE_SCRIPT }}' --force-run ${{ env.FORCE_RUN }}"
          python "${{ env.ENGINE_SCRIPT }}" --force-run ${{ env.FORCE_RUN }}
          
          echo "## ✅ Exécution du script terminée."
          
      # 💾 ÉTAPE 4 (a): Log et vérification des artefacts (étape RUN séparée)
      - name: 💾 Vérification des Artefacts avant Upload
        if: always() 
        run: |
          echo "## 💾 Vérification du dossier des artefacts: app/${{ env.OUTPUT_ROOT }}"
          ls -R app/${{ env.OUTPUT_ROOT }} || echo "⚠️ Le dossier de sortie est vide ou n'existe pas."

      # 💾 ÉTAPE 4 (b): Sauvegarde des artefacts (étape USES séparée)
      - name: ⬆️ Upload des Artefacts de génération
        uses: actions/upload-artifact@v4
        if: always() 
        with:
          name: resultats-${{ github.run_id }}
          path: app/${{ env.OUTPUT_ROOT }} 
          retention-days: 7 
          
  # ===============================================
  # JOB 2: Notifications et Logs de Fin (SANS conteneur, s'exécute toujours)
  # ===============================================
  notification_job:
    runs-on: ubuntu-latest
    needs: engine_run 
    if: always()
    
    steps:
      # 🔔 Notification de Succès
      - name: 🔔 Notification de Succès
        if: success() && needs.engine_run.result == 'success'
        run: |
          echo "==========================================="
          echo "🎉 Le workflow de production s'est terminé avec succès !"
          echo "==========================================="
          
      # 🔔 Notification d'Échec
      - name: 🔔 Notification d'Échec
        if: failure() || needs.engine_run.result == 'failure'
        run: |
          echo "==========================================="
          echo "❌ ÉCHEC CRITIQUE: Le workflow de production a échoué."
          echo "❌ Veuillez consulter les logs du Job 'engine_run' pour diagnostiquer le problème."
          echo "==========================================="
